name: Simple API CD Pipeline

on:
  # Trigger after CI workflow completes successfully
  workflow_run:
    workflows: ["Simple API CI Pipeline"]
    types:
      - completed
    branches: [ "main" ]
  # Allow manual trigger
  workflow_dispatch:

jobs:
  deploy-to-kubernetes:
    runs-on: self-hosted
    # Only run if CI was successful or manually triggered
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    defaults:
      run:
        shell: powershell
        
    steps:
      # ----------------------------------------------------
      # 1. Checkout Source Code
      # ----------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 2. Verify Minikube Environment
      # ----------------------------------------------------
      - name: Verify Minikube Status
        run: |
          minikube status
          kubectl get nodes

      # ----------------------------------------------------
      # 3. Update Container Image Tag
      # ----------------------------------------------------
      - name: Update Deployment Image
        run: |
          (Get-Content k8s/deployment.yaml) -replace 'image: .*simple-api:.*', 'image: ${{ secrets.DOCKERHUB_USERNAME }}/simple-api:${{ github.sha }}' | Set-Content k8s/deployment.yaml
          Get-Content k8s/deployment.yaml | Select-String "image:"

      # ----------------------------------------------------
      # 4. Deploy Application to Kubernetes
      # ----------------------------------------------------
      - name: Create Namespace
        run: kubectl apply -f k8s/namespace.yaml

      - name: Apply ConfigMap
        run: kubectl apply -f k8s/configmap.yaml

      - name: Deploy Application
        run: kubectl apply -f k8s/deployment.yaml

      - name: Apply Service
        run: kubectl apply -f k8s/service.yaml

      # ----------------------------------------------------
      # 5. Monitor Deployment Rollout
      # ----------------------------------------------------
      - name: Wait for Deployment to be Ready
        run: kubectl rollout status deployment/simple-api-deployment -n simple-api --timeout=300s

      # ----------------------------------------------------
      # 6. Verify Deployment Health
      # ----------------------------------------------------
      - name: Verify Deployment
        run: |
          Write-Output "=== Deployment Status ==="
          kubectl get deployment -n simple-api
          Write-Output ""
          Write-Output "=== Pod Status ==="
          kubectl get pods -n simple-api
          Write-Output ""
          Write-Output "=== Service Status ==="
          kubectl get svc -n simple-api

      # ----------------------------------------------------
      # 7. Application Functionality Test (Smoke Test)
      # ----------------------------------------------------
      - name: Run Smoke Test
        run: |
          # Get service URL using minikube
          $SERVICE_URL = minikube service simple-api-service -n simple-api --url
          Write-Output "Service URL: $SERVICE_URL"

          # Test the main API endpoint
          Write-Output "Testing API endpoint..."
          $RESPONSE = Invoke-WebRequest -Uri "$SERVICE_URL/hello" -UseBasicParsing | Select-Object -ExpandProperty Content
          if ($RESPONSE -notmatch "Hello World") {
            Write-Output "API test failed. Expected 'Hello World' in response, got: $RESPONSE"
            exit 1
          }

          # Test actuator health endpoint
          Write-Output "Testing health endpoint..."
          $HEALTH_RESPONSE = Invoke-RestMethod -Uri "$SERVICE_URL/actuator/health"
          if ($HEALTH_RESPONSE.status -ne "UP") {
            Write-Output "Health check failed. Status: $($HEALTH_RESPONSE.status)"
            exit 1
          }

          # Check if pods are running
          $PODS_STATUS = kubectl get pods -n simple-api -l app=simple-api -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}'
          $READY_PODS = ($PODS_STATUS -split ' ' | Where-Object { $_ -eq "True" }).Count
          if ($READY_PODS -lt 1) {
            Write-Output "ERROR: No pods are ready!"
            kubectl describe pods -n simple-api
            kubectl logs -l app=simple-api -n simple-api --tail=50
            exit 1
          }
          Write-Output "SUCCESS: $READY_PODS pod(s) are ready and running"

      # ----------------------------------------------------
      # 8. Basic Security Assessment (DAST Simulation)
      # ----------------------------------------------------
      - name: Perform Basic Security Assessment
        run: |
          Write-Output "Performing basic security assessment..."

          # Get service URL using minikube
          $SERVICE_URL = minikube service simple-api-service -n simple-api --url

          # Test for common security headers
          Write-Output "Checking security headers..."
          try {
            $RESPONSE = Invoke-WebRequest -Uri "$SERVICE_URL/hello" -UseBasicParsing
            $HEADERS = $RESPONSE.Headers
            
            if ($HEADERS.ContainsKey("X-Frame-Options") -or $HEADERS.ContainsKey("X-Content-Type-Options") -or $HEADERS.ContainsKey("X-XSS-Protection")) {
              Write-Output "Warning: Security headers detected - this might indicate additional security measures."
            } else {
              Write-Output "Info: No additional security headers found (expected for basic application)."
            }
          } catch {
            Write-Output "Warning: Could not check security headers"
          }

          # Test for potential information disclosure
          Write-Output "Testing for information disclosure..."
          try {
            $ERROR_RESPONSE = Invoke-WebRequest -Uri "$SERVICE_URL/nonexistent-endpoint" -UseBasicParsing -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Content
            if ($ERROR_RESPONSE -match "stacktrace|exception|error") {
              Write-Output "Warning: Potential information disclosure in error responses."
            } else {
              Write-Output "Info: Error responses appear sanitized."
            }
          } catch {
            Write-Output "Info: Error endpoint returned expected error."
          }

          Write-Output "Basic security assessment completed."

      # ----------------------------------------------------
      # 9. Deployment Summary
      # ----------------------------------------------------
      - name: Generate Deployment Report
        run: |
          Write-Output "Deployment Summary:"
          Write-Output "Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          Write-Output "Commit SHA: ${{ github.sha }}"
          Write-Output "Environment: Minikube/Kubernetes"
          Write-Output ""

          Write-Output "Resource Status:"
          kubectl get all -n simple-api
          Write-Output ""

          Write-Output "Service Accessibility:"
          $SERVICE_URL = minikube service simple-api-service -n simple-api --url
          Write-Output "External URL: $SERVICE_URL"
          Write-Output ""

          Write-Output "Health Check Results:"
          try {
            $HEALTH = Invoke-RestMethod -Uri "$SERVICE_URL/actuator/health"
            $HEALTH | ConvertTo-Json -Depth 10
          } catch {
            Write-Output "Could not retrieve health information"
          }
          Write-Output ""

          Write-Output "Deployment completed successfully."