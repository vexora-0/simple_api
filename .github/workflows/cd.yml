name: Simple API CD Pipeline

on:
  # Trigger after CI workflow completes successfully
  workflow_run:
    workflows: ["Simple API CI Pipeline"]
    types:
      - completed
    branches: [ "main" ]
  # Allow manual trigger
  workflow_dispatch:

jobs:
  deploy-to-kubernetes:
    runs-on: self-hosted
    # Only run if CI was successful or manually triggered
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    defaults:
      run:
        shell: wsl

    steps:
      # ----------------------------------------------------
      # 1. Checkout Source Code
      # ----------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 2. Verify Minikube Environment
      # ----------------------------------------------------
      - name: Verify Minikube Status
        run: |
          minikube status
          kubectl get nodes

      # ----------------------------------------------------
      # 3. Update Container Image Tag
      # ----------------------------------------------------
      - name: Update Deployment Image
        run: |
          sed -i "s|image: .*simple-api:.*|image: ${{ secrets.DOCKERHUB_USERNAME }}/simple-api:${{ github.sha }}|g" k8s/deployment.yaml
          cat k8s/deployment.yaml | grep image:

      # ----------------------------------------------------
      # 4. Deploy Application to Kubernetes
      # ----------------------------------------------------
      - name: Create Namespace
        run: kubectl apply -f k8s/namespace.yaml

      - name: Apply ConfigMap
        run: kubectl apply -f k8s/configmap.yaml

      - name: Deploy Application
        run: kubectl apply -f k8s/deployment.yaml

      - name: Apply Service
        run: kubectl apply -f k8s/service.yaml

      # ----------------------------------------------------
      # 5. Monitor Deployment Rollout
      # ----------------------------------------------------
      - name: Wait for Deployment to be Ready
        run: kubectl rollout status deployment/simple-api-deployment -n simple-api --timeout=300s

      # ----------------------------------------------------
      # 6. Verify Deployment Health
      # ----------------------------------------------------
      - name: Verify Deployment
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployment -n simple-api
          echo ""
          echo "=== Pod Status ==="
          kubectl get pods -n simple-api
          echo ""
          echo "=== Service Status ==="
          kubectl get svc -n simple-api

      # ----------------------------------------------------
      # 7. Application Functionality Test (Smoke Test)
      # ----------------------------------------------------
      - name: Run Smoke Test
        run: |
          # Get service URL using minikube
          SERVICE_URL=$(minikube service simple-api-service -n simple-api --url)
          echo "Service URL: $SERVICE_URL"

          # Test the main API endpoint
          echo "Testing API endpoint..."
          RESPONSE=$(curl -s "$SERVICE_URL/hello")
          if ! echo "$RESPONSE" | grep -q "Hello World"; then
            echo "API test failed. Expected 'Hello World' in response, got: $RESPONSE"
            exit 1
          fi

          # Test actuator health endpoint
          echo "Testing health endpoint..."
          HEALTH_RESPONSE=$(curl -s "$SERVICE_URL/actuator/health")
          if ! echo "$HEALTH_RESPONSE" | grep -q '"status":"UP"'; then
            echo "Health check failed. Response: $HEALTH_RESPONSE"
            exit 1
          fi

          # Check if pods are running
          PODS_STATUS=$(kubectl get pods -n simple-api -l app=simple-api -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}')
          READY_COUNT=$(echo "$PODS_STATUS" | grep -o "True" | wc -l)
          if [ "$READY_COUNT" -lt 1 ]; then
            echo "ERROR: No pods are ready!"
            kubectl describe pods -n simple-api
            kubectl logs -l app=simple-api -n simple-api --tail=50
            exit 1
          fi
          echo "SUCCESS: $READY_COUNT pod(s) are ready and running"

      # ----------------------------------------------------
      # 8. Basic Security Assessment (DAST Simulation)
      # ----------------------------------------------------
      - name: Perform Basic Security Assessment
        run: |
          echo "Performing basic security assessment..."

          # Get service URL using minikube
          SERVICE_URL=$(minikube service simple-api-service -n simple-api --url)

          # Test for common security headers
          echo "Checking security headers..."
          if RESPONSE=$(curl -I -s "$SERVICE_URL/hello"); then
            if echo "$RESPONSE" | grep -qi "X-Frame-Options\|X-Content-Type-Options\|X-XSS-Protection"; then
              echo "Warning: Security headers detected - this might indicate additional security measures."
            else
              echo "Info: No additional security headers found (expected for basic application)."
            fi
          else
            echo "Warning: Could not check security headers"
          fi

          # Test for potential information disclosure
          echo "Testing for information disclosure..."
          if ERROR_RESPONSE=$(curl -s "$SERVICE_URL/nonexistent-endpoint" 2>/dev/null); then
            if echo "$ERROR_RESPONSE" | grep -qi "stacktrace\|exception\|error"; then
              echo "Warning: Potential information disclosure in error responses."
            else
              echo "Info: Error responses appear sanitized."
            fi
          else
            echo "Info: Error endpoint returned expected error."
          fi

          echo "Basic security assessment completed."

      # ----------------------------------------------------
      # 9. Deployment Summary
      # ----------------------------------------------------
      - name: Generate Deployment Report
        run: |
          echo "Deployment Summary:"
          echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Environment: Minikube/Kubernetes"
          echo ""

          echo "Resource Status:"
          kubectl get all -n simple-api
          echo ""

          echo "Service Accessibility:"
          SERVICE_URL=$(minikube service simple-api-service -n simple-api --url)
          echo "External URL: $SERVICE_URL"
          echo ""

          echo "Health Check Results:"
          if HEALTH=$(curl -s "$SERVICE_URL/actuator/health"); then
            echo "$HEALTH"
          else
            echo "Could not retrieve health information"
          fi
          echo ""

          echo "Deployment completed successfully."