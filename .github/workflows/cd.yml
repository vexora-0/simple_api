name: Simple API CD Pipeline

on:
  # Trigger after CI workflow completes successfully
  workflow_run:
    workflows: ["Simple API CI Pipeline"]
    types:
      - completed
    branches: [ "main" ]
  # Allow manual trigger
  workflow_dispatch:

jobs:
  deploy-to-kubernetes:
    runs-on: self-hosted
    # Only run if CI was successful or manually triggered
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      # ----------------------------------------------------
      # 1. Checkout Source Code
      # ----------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 2. Verify Minikube Environment
      # ----------------------------------------------------
      - name: Verify Minikube Status
        shell: bash
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          minikube status
          kubectl get nodes

      # ----------------------------------------------------
      # 3. Update Container Image Tag
      # ----------------------------------------------------
      - name: Update Deployment Image
        shell: bash
        run: |
          sed -i "s|image: .*simple-api:.*|image: ${{ secrets.DOCKERHUB_USERNAME }}/simple-api:${{ github.sha }}|g" k8s/deployment.yaml
          cat k8s/deployment.yaml | grep image:

      # ----------------------------------------------------
      # 4. Deploy Application to Kubernetes
      # ----------------------------------------------------
      - name: Create Namespace
        shell: bash
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          kubectl apply -f k8s/namespace.yaml

      - name: Apply ConfigMap
        shell: bash
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          kubectl apply -f k8s/configmap.yaml

      - name: Deploy Application
        shell: bash
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          kubectl apply -f k8s/deployment.yaml

      - name: Apply Service
        shell: bash
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          kubectl apply -f k8s/service.yaml

      # ----------------------------------------------------
      # 5. Monitor Deployment Rollout
      # ----------------------------------------------------
      - name: Wait for Deployment to be Ready
        shell: bash
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          kubectl rollout status deployment/simple-api-deployment -n simple-api --timeout=300s

      # ----------------------------------------------------
      # 6. Verify Deployment Health
      # ----------------------------------------------------
      - name: Verify Deployment
        shell: bash
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          echo "=== Deployment Status ==="
          kubectl get deployment -n simple-api
          echo ""
          echo "=== Pod Status ==="
          kubectl get pods -n simple-api
          echo ""
          echo "=== Service Status ==="
          kubectl get svc -n simple-api

      # ----------------------------------------------------
      # 7. Application Functionality Test (Smoke Test)
      # ----------------------------------------------------
      - name: Run Smoke Test
        shell: bash
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          # Get service URL using minikube
          SERVICE_URL=$(minikube service simple-api-service -n simple-api --url)
          echo "Service URL: $SERVICE_URL"

          # Test the main API endpoint
          echo "Testing API endpoint..."
          RESPONSE=$(curl -s "$SERVICE_URL/hello")
          if [[ "$RESPONSE" != *"Hello World"* ]]; then
            echo "API test failed. Expected 'Hello World' in response, got: $RESPONSE"
            exit 1
          fi

          # Test actuator health endpoint
          echo "Testing health endpoint..."
          HEALTH_STATUS=$(curl -s "$SERVICE_URL/actuator/health" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
          if [[ "$HEALTH_STATUS" != "UP" ]]; then
            echo "Health check failed. Status: $HEALTH_STATUS"
            exit 1
          fi

          # Check if pods are running
          READY_PODS=$(kubectl get pods -n simple-api -l app=simple-api -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}' | grep -c "True" || echo "0")
          if [ "$READY_PODS" -lt 1 ]; then
            echo "ERROR: No pods are ready!"
            kubectl describe pods -n simple-api
            kubectl logs -l app=simple-api -n simple-api --tail=50
            exit 1
          fi
          echo "SUCCESS: $READY_PODS pod(s) are ready and running"

      # ----------------------------------------------------
      # 8. Basic Security Assessment (DAST Simulation)
      # ----------------------------------------------------
      - name: Perform Basic Security Assessment
        shell: bash
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          echo "Performing basic security assessment..."

          # Get service URL using minikube
          SERVICE_URL=$(minikube service simple-api-service -n simple-api --url)

          # Test for common security headers
          echo "Checking security headers..."
          RESPONSE_HEADERS=$(curl -s -I "$SERVICE_URL/hello")

          # Check if basic security headers are missing (this is expected for a basic Spring Boot app)
          if echo "$RESPONSE_HEADERS" | grep -q "X-Frame-Options\|X-Content-Type-Options\|X-XSS-Protection"; then
            echo "Warning: Security headers detected - this might indicate additional security measures."
          else
            echo "Info: No additional security headers found (expected for basic application)."
          fi

          # Test for potential information disclosure
          echo "Testing for information disclosure..."
          ERROR_RESPONSE=$(curl -s "$SERVICE_URL/nonexistent-endpoint" || true)
          if echo "$ERROR_RESPONSE" | grep -q -i "stacktrace\|exception\|error"; then
            echo "Warning: Potential information disclosure in error responses."
          else
            echo "Info: Error responses appear sanitized."
          fi

          echo "Basic security assessment completed."

      # ----------------------------------------------------
      # 9. Deployment Summary
      # ----------------------------------------------------
      - name: Generate Deployment Report
        shell: bash
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          echo "Deployment Summary:"
          echo "Timestamp: $(date)"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Environment: Minikube/Kubernetes"
          echo ""

          echo "Resource Status:"
          kubectl get all -n simple-api
          echo ""

          echo "Service Accessibility:"
          SERVICE_URL=$(minikube service simple-api-service -n simple-api --url)
          echo "External URL: $SERVICE_URL"
          echo ""

          echo "Health Check Results:"
          curl -s "$SERVICE_URL/actuator/health" | python3 -m json.tool 2>/dev/null || curl -s "$SERVICE_URL/actuator/health"
          echo ""

          echo "Deployment completed successfully."